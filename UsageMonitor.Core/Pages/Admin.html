<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usage Monitor - Admin</title>
    <link rel="stylesheet" href="css/core.css">
    <link rel="stylesheet" href="css/theme.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="js/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>
    <div style="display:inline-flex" class="layout-wrapper ">
        <aside style="width:20rem" class=" layout-menu menu-vertical menu bg-menu-theme">
            <div class="app-brand demo">
                <a href="#" class="app-brand-link">
                    <h4 class="app-brand-text fw-bold ms-2">Usage Monitor</h4>
                </a>
                <a  class="layout-menu-toggle menu-link ms-auto d-xl-none">
                    <i class="bx bx-chevron-left bx-sm"></i>
                </a>
            </div>

            <ul class="menu-inner py-1 " >
                <li class="menu-item active">
                    <a href="#overview" class="menu-link" data-section="overview">
                        <i class="menu-icon bx bx-home-circle"></i>
                        <div>Overview</div>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#payments" class="menu-link" data-section="payments">
                        <i class="menu-icon bx bx-credit-card"></i>
                        <div>Payments</div>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#analytics" class="menu-link" data-section="analytics">
                        <i class="menu-icon bx bx-chart"></i>
                        <div>Analytics</div>
                    </a>
                </li>
            </ul>
        </aside>

        <div class=" layout-page w-100">
            <div class="content-wrapper">
                <!-- Overview Section -->
                <div id="overview" class="content-section active">
                    <div class="container-xxl flex-grow-1 container-p-y">
                        <!-- Your existing content here -->
                        <div class="row mb-4">
                            <h2 >API Client Overview</h2>
                        </div>
                        <div id="client-view">
                            <div id="client-card" style="display:none;">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title" id="clientName"></h5>
                                        <p class="card-text">
                                            <strong>Email:</strong> <span id="clientEmail"></span><br>
                                            <strong>Usage:</strong> <span id="clientUsage"></span>/<span id="clientLimit"></span> requests
                                        </p>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-primary" id="editClientBtn">Edit Details</button>
                                            <button class="btn btn-success" id="addPaymentBtn">Update Usage Limit</button>
                                            <button class="btn btn-info" id="reportBtn">Download Report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="payments" class="content-section">
                    <div class="container-xxl flex-grow-1 container-p-y">
                        <!-- Active Payment Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0 text-white fw-bold">Current Active Payment</h5>
                                    </div>
                                    <div class="card-body" id="activePaymentSection">
                                        <div class="alert alert-info" role="alert">
                                            Loading active payment information...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Timeline -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <h5 class="card-header">Payment Timeline</h5>
                                    <div class="card-body">
                                        <ul class="timeline mb-0" id="paymentTimeline">
                                            <!-- Timeline items will be inserted here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment History Table -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Payment History</h5>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Unit Price</th>
                                                    <th>Total Requests</th>
                                                    <th>Used</th>
                                                    <th>Remaining</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentsTableBody">
                                                <!-- Payments will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analytics" class="content-section">
                    <div class="container-xxl flex-grow-1 container-p-y">
                        <div class="row mb-4">
                            <h2>Usage Analytics</h2>
                        </div>

                        <!-- Usage Overview Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start justify-content-between">
                                            <div class="content-left">
                                                <span class="fw-bold fs-4 mb-2" id="totalRequestsCount">0</span>
                                                <p class="mb-0">Total Requests</p>
                                            </div>
                                            <div class="avatar">
                                                <span class="avatar-initial rounded bg-label-primary">
                                                    <i class="bx bx-transfer text-primary"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start justify-content-between">
                                            <div class="content-left">
                                                <span class="fw-bold fs-4 mb-2" id="successRate">0%</span>
                                                <p class="mb-0">Success Rate</p>
                                            </div>
                                            <div class="avatar">
                                                <span class="avatar-initial rounded bg-label-success">
                                                    <i class="bx bx-check-circle text-success"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start justify-content-between">
                                            <div class="content-left">
                                                <span class="fw-bold fs-4 mb-2" id="avgResponseTime">0ms</span>
                                                <p class="mb-0">Avg Response Time</p>
                                            </div>
                                            <div class="avatar">
                                                <span class="avatar-initial rounded bg-label-info">
                                                    <i class="bx bx-time text-info"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start justify-content-between">
                                            <div class="content-left">
                                                <span class="fw-bold fs-4 mb-2" id="errorRate">0%</span>
                                                <p class="mb-0">Error Rate</p>
                                            </div>
                                            <div class="avatar">
                                                <span class="avatar-initial rounded bg-label-danger">
                                                    <i class="bx bx-error-circle text-danger"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Row -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Daily Request Volume</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary active" data-range="7">7D</button>
                                            <button class="btn btn-sm btn-outline-primary" data-range="30">30D</button>
                                            <button class="btn btn-sm btn-outline-primary" data-range="90">90D</button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="requestVolumeChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Response Status Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="statusDistributionChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Charts Row -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Top Endpoints</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="topEndpointsChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Response Time Trend</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="responseTimeChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <!-- Add Client Modal -->
    <div class="modal fade" id="initialClientModal" data-bs-backdrop="static" data-bs-keyboard="false"
        tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New API Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newClientForm">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount Paid</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="amountPaid" required min="1"
                                    step="1">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price per Request</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="unitPrice" required min="0.01"
                                    step="0.01">
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="txtUsagePreview" readonly 
                                    placeholder="Available Requests">
                                <button class="btn btn-outline-success" type="button" id="btnUsagePreview">
                                    Calculate available requests
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer gap-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNewClient">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal fade" id="editClientModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editClientForm">
                        <input type="hidden" name="clientId">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer gap-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveClientEdit">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Filter Modal -->
    <div class="modal fade" id="reportFilterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Download Usage Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reportFilterForm">
                        <input type="hidden" name="clientCreatedAt" id="clientCreatedAt">
                        <div class="mb-3">
                            <label class="form-label">Time Range</label>
                            <select class="form-select" id="timeRangeSelect">
                                <option value="thisMonth">This Month</option>
                                <option value="allTime">All Time</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <div id="customDateRange" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">From</label>
                                <input type="datetime-local" class="form-control" id="startDate">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">To</label>
                                <input type="datetime-local" class="form-control" id="endDate">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer gap-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="downloadReport()">Download</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Add Payment Modal -->
    <div class="modal fade" id="addPaymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editLimitForm">
                        <input type="hidden" name="clientId">
                        <div class="mb-3">
                            <label class="form-label">Payment Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="additionalAmount" required
                                    min="0.01" step="0.01" id="newPaymentAmount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Unit Price </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="paymentUnitPrice"
                                       min="0.01" step="0.01" id="newPaymentUnitPrice">
                                <button class="btn btn-outline-success" type="button" id="calculateNewPayment">
                                    Calculate
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Additional Requests Available</label>
                            <input type="text" class="form-control" id="newPaymentPreview" readonly
                                placeholder="Enter amount and price to see available requests">
                        </div>
                    </form>
                </div>
                <div class="modal-footer gap-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNewPayment">Add Payment</button>
                </div>
            </div>
        </div>
    </div>


    <script src="js/bootstrap.js"></script>
    <script src="js/chart.js"></script>

    <script>
         

        document.addEventListener('DOMContentLoaded', async () => {
            await loadClient();
            await loadPayments();
            setupEventListeners();
        });

        async function loadPayments() {
            try {
                const response = await fetch('/api/usgm/payments');
                const payments = await response.json();

                console.log(payments)
                
                // Find active payment (first payment with remaining requests)
                const activePayment = payments.find(p => p.remainingRequests > 0);
                const activePaymentSection = document.getElementById('activePaymentSection');
                
                if (activePayment) {
                    const usagePercentage = ((activePayment.usedRequests / activePayment.totalRequests) * 100).toFixed(1);
                    activePaymentSection.innerHTML = `
                        <div class="row g-4 mt-3">
                            <div class="col-md-6">
                                <div class="p-3 border rounded h-100">
                                    <h6 class="fw-bold mb-4">Payment Details</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Amount:</span>
                                            <span class="fw-semibold">$${activePayment.amount.toFixed(2)}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Date:</span>
                                            <span class="fw-semibold">${new Date(activePayment.createdAt).toLocaleDateString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">Unit Price:</span>
                                            <span class="fw-semibold">$${activePayment.unitPrice.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 border rounded h-100">
                                    <h6 class="fw-bold mb-4">Usage Statistics</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Total Requests:</span>
                                            <span class="fw-semibold">${activePayment.totalRequests.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Used:</span>
                                            <span class="fw-semibold">${activePayment.usedRequests.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="text-muted">Remaining:</span>
                                            <span class="fw-semibold">${activePayment.remainingRequests.toLocaleString()}</span>
                                        </div>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                 style="width: ${usagePercentage}%;" 
                                                 aria-valuenow="${usagePercentage}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                ${usagePercentage}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    activePaymentSection.innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            No active payment found. Please add a new payment to continue using the API.
                        </div>
                    `;
                }
                
                // Update timeline view
                const timeline = document.getElementById('paymentTimeline');
                timeline.innerHTML = payments.map((payment, index) => {
                    const date = new Date(payment.createdAt);
                    const timeAgo = getTimeAgo(date);
                    const isActive = payment.remainingRequests > 0;
                    return `
                        <li class="timeline-item timeline-item-transparent">
                            <span class="timeline-point timeline-point-${isActive ? 'success' : 'secondary'}"></span>
                            <div class="timeline-event">
                                <div class="timeline-header mb-3">
                                    <h6 class="mb-0">Payment of ${payment.amount.toFixed(2)}</h6>
                                    <small class="text-muted">${timeAgo}</small>
                                </div>
                                <p class="mb-2">
                                    ${payment.totalRequests.toLocaleString()} requests at ${payment.unitPrice.toFixed(2)} per request
                                </p>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="badge ${isActive ? 'bg-success' : 'bg-secondary'} rounded">
                                        ${isActive ? 'Active' : 'Depleted'} - ${payment.usedRequests.toLocaleString()} used
                                    </div>
                                </div>
                            </div>
                        </li>
                    `;
                }).join('');

                // Display payment history table
                const tableBody = document.getElementById('paymentsTableBody');
                tableBody.innerHTML = payments.map(payment => `
                    <tr>
                        <td>${new Date(payment.createdAt).toLocaleDateString()}</td>
                        <td>${payment.amount.toFixed(2)}</td>
                        <td>${payment.unitPrice?.toFixed(2) || 'N/A'}</td>
                        <td>${payment.totalRequests.toLocaleString()}</td>
                        <td>${payment.usedRequests.toLocaleString()}</td>
                        <td>${payment.remainingRequests.toLocaleString()}</td>
                        <td>
                            <span class="badge bg-${payment.remainingRequests > 0 ? 'success' : 'secondary'}">
                                ${payment.remainingRequests > 0 ? 'Active' : 'Depleted'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        let clientData;

        async function loadClient() {
            try {
                const response = await fetch('/api/usgm/client');
                if (response.status === 404) {
                    // No client exists, show initial setup modal
                    new bootstrap.Modal(document.getElementById('initialClientModal')).show();
                    return;
                }

                clientData = await response.json();
                const usage = await getClientUsage();
                console.log(usage);
                console.log(clientData);

                document.getElementById('clientName').textContent = clientData.name;
                document.getElementById('clientEmail').textContent = clientData.email;
                document.getElementById('clientUsage').textContent = usage.usedRequests;
                document.getElementById('clientLimit').textContent = usage.totalRequests;

                document.getElementById('client-card').style.display = 'block';

            } catch (error) {
                console.error('Error loading client:', error);
            }
        }

        function setupEventListeners() {
            attachModalHandlers();
            attachPreviewHandlers();
            attachFormHandlers();
        }

        function attachModalHandlers() {
            // Get buttons by ID and attach listeners
            document.getElementById('editClientBtn')?.addEventListener('click', showEditClientModal);
            document.getElementById('addPaymentBtn')?.addEventListener('click', showAddPaymentModal);
            document.getElementById('reportBtn')?.addEventListener('click', showReportModal);
        }

        function attachPreviewHandlers() {
            // Initial client preview calculation
            document.getElementById('btnUsagePreview').addEventListener('click', () => {
                calculateRequestPreview(
                    'input[name="amountPaid"]',
                    'input[name="unitPrice"]',
                    'txtUsagePreview'
                );
            });

            // New payment preview calculation
            document.getElementById('calculateNewPayment')?.addEventListener('click', () => {
                calculateRequestPreview(
                    '#newPaymentAmount',
                    '#newPaymentUnitPrice',
                    'newPaymentPreview'
                );
            });

            // Auto-calculate on input changes for both forms
            ['amountPaid', 'unitPrice'].forEach(field => {
                document.querySelector(`input[name="${field}"]`)?.addEventListener('input', () => {
                    calculateRequestPreview(
                        'input[name="amountPaid"]',
                        'input[name="unitPrice"]',
                        'txtUsagePreview'
                    );
                });
            });

            // Auto-calculate on input changes for new payment form
            ['newPaymentAmount', 'newPaymentUnitPrice'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', () => {
                    calculateRequestPreview(
                        '#newPaymentAmount',
                        '#newPaymentUnitPrice',
                        'newPaymentPreview'
                    );
                });
            });
        }

        // Helper function to calculate request preview
        function calculateRequestPreview(amountSelector, priceSelector, outputId) {
            const amount = parseFloat(document.querySelector(amountSelector)?.value || '0');
            const unitPrice = parseFloat(document.querySelector(priceSelector)?.value || '0');
            const preview = document.getElementById(outputId);

            if (amount && unitPrice && unitPrice > 0) {
                const requests = Math.floor(amount / unitPrice);
                preview.value = `${requests.toLocaleString()} requests available`;
            } else {
                preview.value = 'Enter amount and price to see available requests';
            }
        }

        function attachFormHandlers() {
            // Existing form submission handlers, but cleaned up
            document.getElementById('saveNewClient').addEventListener('click', handleNewClientSubmit);
            document.getElementById('saveClientEdit').addEventListener('click', handleClientEditSubmit);
            document.getElementById('saveNewPayment').addEventListener('click', submitNewPayment);
        }

        async function handleNewClientSubmit() {
            const form = document.getElementById('newClientForm');
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/usgm/client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        email: formData.get('email'),
                        amountPaid: parseFloat(formData.get('amountPaid')),
                        unitPrice: parseFloat(formData.get('unitPrice'))
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('initialClientModal')).hide();
                    form.reset();
                    await loadClient();
                }
            } catch (error) {
                console.error('Error creating client:', error);
            }
        }

        async function handleClientEditSubmit() {
            const form = document.getElementById('editClientForm');
            const formData = new FormData(form);
            try {
                // Preserve existing values from clientData
                const updatedClient = {
                    ...clientData,
                    name: formData.get('name'),
                    email: formData.get('email')
                };

                const response = await fetch('/api/usgm/client', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedClient)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editClientModal')).hide();
                    form.reset();
                    await loadClient();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to update client');
                }
            } catch (error) {
                console.error('Error updating client:', error);
                showError('Failed to update client');
            }
        }

        async function submitNewPayment() {
            const form = document.getElementById('editLimitForm');
            const additionalAmount = parseFloat(document.getElementById('newPaymentAmount').value);
            const unitPrice = parseFloat(document.getElementById('newPaymentUnitPrice').value);

            if (!additionalAmount || !unitPrice) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch('/api/usgm/client/payment', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        additionalAmount,
                        unitPrice
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to add payment');
                }

                // Close modal and refresh data
                bootstrap.Modal.getInstance(document.getElementById('addPaymentModal')).hide();
                await loadClientData();
                await loadPayments();
                
                // Show success message
                showToast('Success', 'Payment added successfully', 'success');
            } catch (error) {
                console.error('Error adding payment:', error);
                showToast('Error', 'Failed to add payment', 'error');
            }
        }

        async function getClientUsage() {
            try {
                const response = await fetch(`/api/usgm/client/usage`);
                const usage = await response.json();
                return usage;
            } catch (error) {
                console.error('Error getting usage:', error);
                return '?';
            }
        }

        function showEditClientModal() {
            const form = document.getElementById('editClientForm');
            const client = {
                name: document.getElementById('clientName').textContent,
                email: document.getElementById('clientEmail').textContent
            };

            form.querySelector('input[name="clientId"]').value = client.clientId;
            form.querySelector('input[name="name"]').value = client.name;
            form.querySelector('input[name="email"]').value = client.email;

            new bootstrap.Modal(document.getElementById('editClientModal')).show();
        }

        function showAddPaymentModal() {
            new bootstrap.Modal(document.getElementById('addPaymentModal')).show();
        }

        function showReportModal(createdAt) {
            document.getElementById('clientCreatedAt').value = createdAt;
            document.getElementById('timeRangeSelect').value = 'thisMonth';
            document.getElementById('customDateRange').style.display = 'none';
            new bootstrap.Modal(document.getElementById('reportFilterModal')).show();
        }

        document.getElementById('timeRangeSelect').addEventListener('change', function () {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'block';
                // Set min date to client creation date
                const createdAt = new Date(document.getElementById('clientCreatedAt').value);
                document.getElementById('startDate').min = createdAt.toISOString().slice(0, 16);
                document.getElementById('startDate').value = createdAt.toISOString().slice(0, 16);
                document.getElementById('endDate').value = new Date().toISOString().slice(0, 16);
            } else {
                customRange.style.display = 'none';
            }
        });

        async function downloadReport() {
            const timeRange = document.getElementById('timeRangeSelect').value;
            let startDate, endDate;

            if (timeRange === 'thisMonth') {
                startDate = new Date();
                startDate.setDate(1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date();
            } else if (timeRange === 'allTime') {
                startDate = new Date(document.getElementById('clientCreatedAt').value);
                endDate = new Date();
            } else {
                startDate = new Date(document.getElementById('startDate').value);
                endDate = new Date(document.getElementById('endDate').value);
            }

            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }

            const createdAt = new Date(document.getElementById('clientCreatedAt').value);
            if (startDate < createdAt) {
                alert('Start date cannot be before client creation date');
                return;
            }

            window.location.href = `/api/usgm/client/report?startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`;
            bootstrap.Modal.getInstance(document.getElementById('reportFilterModal')).hide();
        }
    
          // Add new sidebar navigation logic
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                link.parentElement.classList.add('active');
                
                // Show selected section
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(section).classList.add('active');
            });
        });

        // Mobile menu toggle
        document.querySelector('.layout-menu-toggle').addEventListener('click', () => {
            document.querySelector('.layout-menu').classList.toggle('show');
        });
    
        function getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            // Handle "just now" more precisely (within 30 seconds)
            if (seconds < 30) {
                return 'just now';
            }

            // Less than a minute
            if (seconds < 60) {
                return `${seconds} seconds ago`;
            }

            // Minutes
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) {
                return minutes === 1 ? 'a minute ago' : `${minutes} minutes ago`;
            }

            // Hours
            const hours = Math.floor(minutes / 60);
            if (hours < 24) {
                return hours === 1 ? 'an hour ago' : `${hours} hours ago`;
            }

            // Days
            const days = Math.floor(hours / 24);
            if (days < 30) {
                return days === 1 ? 'yesterday' : `${days} days ago`;
            }

            // Months
            const months = Math.floor(days / 30);
            if (months < 12) {
                return months === 1 ? 'a month ago' : `${months} months ago`;
            }

            // Years
            const years = Math.floor(months / 12);
            return years === 1 ? 'a year ago' : `${years} years ago`;
        }

        async function loadAnalytics() {
            try {
                const [overviewResponse, timelineResponse, endpointsResponse, responseTimesResponse] = await Promise.all([
                    fetch('/api/usgm/analytics/overview'),
                    fetch('/api/usgm/analytics/timeline'),
                    fetch('/api/usgm/analytics/top-endpoints'),
                    fetch('/api/usgm/analytics/response-times')
                ]);

                const overview = await overviewResponse.json();
                const timeline = await timelineResponse.json();
                const endpoints = await endpointsResponse.json();
                const responseTimes = await responseTimesResponse.json();

                updateOverviewCards(overview);
                initializeCharts(overview, timeline, endpoints, responseTimes);
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Error', 'Failed to load analytics data', 'error');
            }
        }

        function updateOverviewCards(stats) {
            document.getElementById('totalRequestsCount').textContent = stats.totalRequests.toLocaleString();
            document.getElementById('successRate').textContent = `${stats.successRate.toFixed(1)}%`;
            document.getElementById('avgResponseTime').textContent = `${stats.avgResponseTime.toFixed(0)}ms`;
            document.getElementById('errorRate').textContent = `${stats.errorRate.toFixed(1)}%`;
        }

        function initializeCharts(stats, timeline, endpoints, responseTimes) {
            // Request Volume Chart
            new Chart(document.getElementById('requestVolumeChart'), {
                type: 'line',
                data: {
                    labels: timeline.dates,
                    datasets: [{
                        label: 'Requests',
                        data: timeline.counts,
                        borderColor: '#696cff',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(105, 108, 255, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                borderDash: [2]
                            }
                        }
                    }
                }
            });

            // Status Distribution Chart
            new Chart(document.getElementById('statusDistributionChart'), {
                type: 'doughnut',
                data: {
                    labels: ['2xx', '4xx', '5xx'],
                    datasets: [{
                        data: [stats.status2xx, stats.status4xx, stats.status5xx],
                        backgroundColor: ['#71dd37', '#ff3e1d', '#8592a3']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Top Endpoints Chart
            new Chart(document.getElementById('topEndpointsChart'), {
                type: 'bar',
                data: {
                    labels: endpoints.map(e => e.path),
                    datasets: [{
                        label: 'Requests',
                        data: endpoints.map(e => e.requestCount),
                        backgroundColor: '#696cff',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Response Time Trend Chart
            new Chart(document.getElementById('responseTimeChart'), {
                type: 'line',
                data: {
                    labels: responseTimes.dates,
                    datasets: [{
                        label: 'Avg Response Time (ms)',
                        data: responseTimes.avgTimes,
                        borderColor: '#03c3ec',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(3, 195, 236, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                borderDash: [2]
                            }
                        }
                    }
                }
            });
        }

        // Add event listeners for date range buttons
        document.querySelectorAll('[data-range]').forEach(button => {
            button.addEventListener('click', async (e) => {
                // Remove active class from all buttons
                document.querySelectorAll('[data-range]').forEach(btn => 
                    btn.classList.remove('active'));
                // Add active class to clicked button
                e.target.classList.add('active');

                const days = e.target.dataset.range;
                await loadAnalytics(days);
            });
        });

        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                loadClient(),
                loadPayments(),
                loadAnalytics()
            ]);

            // Add navigation handling
            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const section = e.currentTarget.getAttribute('data-section');
                    
                    // Update active states
                    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                    e.currentTarget.parentElement.classList.add('active');
                    
                    // Hide all sections and show the selected one
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(section).classList.add('active');

                    // Reload data when switching to analytics
                    if (section === 'analytics') {
                        await loadAnalytics();
                    }
                });
            });
        });

        // Add periodic refresh for analytics
        setInterval(async () => {
            if (document.getElementById('analytics').classList.contains('active')) {
                await loadAnalytics();
            }
        }, 30000); // Refresh every 30 seconds if analytics section is active
    </script>
</body>

</html>

<style>
    body{
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .layout-wrapper {

        min-height: 100vh;
    }

    .layout-menu {
        flex-shrink: 0;
        background: #fff;
        border-right: 1px solid rgba(0,0,0,.05);
        padding: 1rem;
    }

    .layout-page {
        flex-grow: 1;
    }

    .menu-inner {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .menu-item {
        margin-bottom: .5rem;
    }

    .menu-link {
        display: flex;
        align-items: center;
        padding: .625rem 1rem;
        color: #697a8d;
        border-radius: .375rem;
        text-decoration: none;
        transition: all .2s ease-in-out;
    }

    .menu-link:hover {
        background: rgba(105,108,255,.16);
        color: #696cff;
    }

    .menu-item.active .menu-link {
        background: rgba(105,108,255,.16);
        color: #696cff;
        font-weight: 600;
    }

    .menu-icon {
        margin-right: .5rem;
        font-size: 1.25rem;
    }

    .content-section {
        display: none;
        padding: 1.5rem;
    }

    .content-section.active {
        display: block;
    }

    .container-p-y {
        padding: 1.5rem 0;
    }

    .app-brand {
        padding: 0 1rem;
        margin-bottom: 1.5rem;
    }

    .app-brand-link {
        display: flex;
        align-items: center;
        text-decoration: none;
        color: #696cff;
    }

    @media (max-width: 1199.98px) {
        .layout-menu {
            position: fixed;
            top: 0;
            left: -200px;
            height: 100vh;
            z-index: 1050;
            transition: left .2s ease-in-out;
        }

        .layout-menu.show {
            left: 0;
        }
    }

    .avatar {
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .avatar-initial {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .bg-label-primary {
        background-color: #e7e7ff !important;
    }

    .bg-label-success {
        background-color: #e8fadf !important;
    }

    .bg-label-info {
        background-color: #d7f5fc !important;
    }

    .bg-label-danger {
        background-color: #ffe0db !important;
    }

    .card {
        box-shadow: 0 0.25rem 1rem rgba(161, 172, 184, 0.45);
    }
</style>