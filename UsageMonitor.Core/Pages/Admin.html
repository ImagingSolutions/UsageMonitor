<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usage Monitor - Admin</title>
    <link rel="stylesheet" href="css/core.css">
    <link rel="stylesheet" href="css/theme.css">
</head>

<body>
    <div class=" w-100">

        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 w-100 ">
            <div class="container ">
                <p class="text-center">Api Usage Management Admin</p>
            </div>
        </nav>

        <!-- Add Client Modal -->
        <div class="modal fade" id="initialClientModal" data-bs-backdrop="static" data-bs-keyboard="false"
            tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">New API Client</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newClientForm">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Amount Paid</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="amountPaid" required min="1"
                                        step="1">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Price per Request</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="unitPrice" required min="0.01"
                                        step="0.01">
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="txtUsagePreview" readonly 
                                        placeholder="Available Requests">
                                    <button class="btn btn-outline-success" type="button" id="btnUsagePreview">
                                        Calculate available requests
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer gap-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveNewClient">Create</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client View  -->
        <div id="client-view" class="container">
            <div class="row mb-4">
                <h2>
                    API Client
                </h2>
            </div>
            <!-- Client Card -->
            <div class="row">
                <div class="col">
                    <div id="client-card" style="display:none;">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title" id="clientName"></h5>
                                <p class="card-text">
                                    <strong>Email:</strong> <span id="clientEmail"></span><br>
                                    <strong>Usage:</strong> <span id="clientUsage"></span>/<span
                                        id="clientLimit"></span> requests
                                </p>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-primary" id="editClientBtn">Edit Details</button>
                                    <button class="btn btn-success" id="addPaymentBtn">Update Usage Limit</button>
                                    <button class="btn btn-info" id="reportBtn">Download Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Client Modal -->
        <div class="modal fade" id="editClientModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Client</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editClientForm">
                            <input type="hidden" name="clientId">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer gap-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveClientEdit">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Filter Modal -->
        <div class="modal fade" id="reportFilterModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Download Usage Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="reportFilterForm">
                            <input type="hidden" name="clientCreatedAt" id="clientCreatedAt">
                            <div class="mb-3">
                                <label class="form-label">Time Range</label>
                                <select class="form-select" id="timeRangeSelect">
                                    <option value="thisMonth">This Month</option>
                                    <option value="allTime">All Time</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>

                            <div id="customDateRange" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">From</label>
                                    <input type="datetime-local" class="form-control" id="startDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">To</label>
                                    <input type="datetime-local" class="form-control" id="endDate">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer gap-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="downloadReport()">Download</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Add Payment Modal -->
        <div class="modal fade" id="addPaymentModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Payment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editLimitForm">
                            <input type="hidden" name="clientId">
                            <div class="mb-3">
                                <label class="form-label">Additional Payment Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="additionalAmount" required
                                        min="0.01" step="0.01">
                                    <button class="btn btn-outline-success" type="button" id="btnPaymentPreview">
                                        Calculate
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Additional Requests Available</label>
                                <p class="form-text" id="paymentPreview">Enter amount to see additional requests</p>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer gap-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveNewLimit">Save</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="js/bootstrap.js"></script>
    <script src="js/chart.js"></script>

    <script>
         

        document.addEventListener('DOMContentLoaded', async () => {
            await loadClient();
            setupEventListeners();
        });

        let clientData;

        async function loadClient() {
            try {
                const response = await fetch('/api/usgm/client');
                if (response.status === 404) {
                    // No client exists, show initial setup modal
                    new bootstrap.Modal(document.getElementById('initialClientModal')).show();
                    return;
                }

                clientData = await response.json();
                const usage = await getClientUsage();

                // Update client card
                document.getElementById('clientName').textContent = clientData.name;
                document.getElementById('clientEmail').textContent = clientData.email;
                document.getElementById('clientUsage').textContent = usage;
                document.getElementById('clientLimit').textContent = clientData.usageLimit;

                document.getElementById('client-card').style.display = 'block';

            } catch (error) {
                console.error('Error loading client:', error);
            }
        }

        function setupEventListeners() {
            // Only attach modal handlers if client exists
            if (document.getElementById('client-card').style.display !== 'none') {
                attachModalHandlers();
            }
            
            // These should always be attached
            attachPreviewHandlers();
            attachFormHandlers();
        }

        function attachModalHandlers() {
            // Get buttons by ID and attach listeners
            const editBtn = document.getElementById('editClientBtn');
            const paymentBtn = document.getElementById('addPaymentBtn');
            const reportBtn = document.getElementById('reportBtn');

            if (editBtn) editBtn.addEventListener('click', showEditClientModal);
            if (paymentBtn) paymentBtn.addEventListener('click', showAddPaymentModal);
            if (reportBtn) reportBtn.addEventListener('click', showReportModal);
        }

        function attachPreviewHandlers() {
            // Fix preview calculations
            document.getElementById('btnUsagePreview').addEventListener('click', () => {
                const amountPaid = parseFloat(document.querySelector('input[name="amountPaid"]').value);
                const unitPrice = parseFloat(document.querySelector('input[name="unitPrice"]').value);
                const preview = document.getElementById('txtUsagePreview');

                if (amountPaid && unitPrice) {
                    const requests = Math.floor(amountPaid / unitPrice);
                    preview.value = `${requests.toLocaleString()} requests available`;
                } else {
                    preview.value = 'Enter amount and price to see available requests';
                }
            });

            document.getElementById('btnPaymentPreview').addEventListener('click', () => {
                const additionalAmount = parseFloat(document.querySelector('input[name="additionalAmount"]').value);
                const preview = document.getElementById('paymentPreview');
                const unitPrice = clientData.unitPrice; // Using global clientData

                if (additionalAmount && unitPrice) {
                    const additionalRequests = Math.floor(additionalAmount / unitPrice);
                    preview.textContent = `${additionalRequests.toLocaleString()} additional requests`;
                } else {
                    preview.textContent = 'Enter amount to see additional requests';
                }
            });

            // Auto-calculate on input changes
            ['amountPaid', 'unitPrice'].forEach(field => {
                document.querySelector(`input[name="${field}"]`).addEventListener('input', () => {
                    document.getElementById('btnUsagePreview').click();
                });
            });

            document.querySelector('input[name="additionalAmount"]').addEventListener('input', () => {
                document.getElementById('btnPaymentPreview').click();
            });
        }

        function attachFormHandlers() {
            // Existing form submission handlers, but cleaned up
            document.getElementById('saveNewClient').addEventListener('click', handleNewClientSubmit);
            document.getElementById('saveClientEdit').addEventListener('click', handleClientEditSubmit);
            document.getElementById('saveNewLimit').addEventListener('click', handleNewLimitSubmit);
        }

        async function handleNewClientSubmit() {
            const form = document.getElementById('newClientForm');
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/usgm/client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        email: formData.get('email'),
                        amountPaid: parseFloat(formData.get('amountPaid')),
                        unitPrice: parseFloat(formData.get('unitPrice'))
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('initialClientModal')).hide();
                    form.reset();
                    await loadClient();
                }
            } catch (error) {
                console.error('Error creating client:', error);
            }
        }

        async function handleClientEditSubmit() {
            const form = document.getElementById('editClientForm');
            const formData = new FormData(form);
            try {
                // Preserve existing values from clientData
                const updatedClient = {
                    ...clientData,
                    name: formData.get('name'),
                    email: formData.get('email')
                };

                const response = await fetch('/api/usgm/client', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedClient)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editClientModal')).hide();
                    form.reset();
                    await loadClient();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to update client');
                }
            } catch (error) {
                console.error('Error updating client:', error);
                showError('Failed to update client');
            }
        }

        async function handleNewLimitSubmit() {
            const form = document.getElementById('editLimitForm');
            const formData = new FormData(form);
            const additionalAmount = parseFloat(formData.get('additionalAmount'));
            
            try {
                const response = await fetch('/api/usgm/client/payment', {
                    method: 'PATCH', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        additionalAmount: additionalAmount
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addPaymentModal')).hide();
                    form.reset();
                    await loadClient();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to update payment');
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                showError('Failed to update payment');
            }
        }

        async function getClientUsage() {
            try {
                const response = await fetch(`/api/usgm/client/usage`);
                const usage = await response.json();
                return usage.count;
            } catch (error) {
                console.error('Error getting usage:', error);
                return '?';
            }
        }

        function showEditClientModal() {
            const form = document.getElementById('editClientForm');
            const client = {
                name: document.getElementById('clientName').textContent,
                email: document.getElementById('clientEmail').textContent
            };

            form.querySelector('input[name="clientId"]').value = client.clientId;
            form.querySelector('input[name="name"]').value = client.name;
            form.querySelector('input[name="email"]').value = client.email;

            new bootstrap.Modal(document.getElementById('editClientModal')).show();
        }

        function showAddPaymentModal() {
            new bootstrap.Modal(document.getElementById('addPaymentModal')).show();
        }

        function showReportModal(createdAt) {
            document.getElementById('clientCreatedAt').value = createdAt;
            document.getElementById('timeRangeSelect').value = 'thisMonth';
            document.getElementById('customDateRange').style.display = 'none';
            new bootstrap.Modal(document.getElementById('reportFilterModal')).show();
        }

        document.getElementById('timeRangeSelect').addEventListener('change', function () {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'block';
                // Set min date to client creation date
                const createdAt = new Date(document.getElementById('clientCreatedAt').value);
                document.getElementById('startDate').min = createdAt.toISOString().slice(0, 16);
                document.getElementById('startDate').value = createdAt.toISOString().slice(0, 16);
                document.getElementById('endDate').value = new Date().toISOString().slice(0, 16);
            } else {
                customRange.style.display = 'none';
            }
        });

        async function downloadReport() {
            const timeRange = document.getElementById('timeRangeSelect').value;
            let startDate, endDate;

            if (timeRange === 'thisMonth') {
                startDate = new Date();
                startDate.setDate(1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date();
            } else if (timeRange === 'allTime') {
                startDate = new Date(document.getElementById('clientCreatedAt').value);
                endDate = new Date();
            } else {
                startDate = new Date(document.getElementById('startDate').value);
                endDate = new Date(document.getElementById('endDate').value);
            }

            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }

            const createdAt = new Date(document.getElementById('clientCreatedAt').value);
            if (startDate < createdAt) {
                alert('Start date cannot be before client creation date');
                return;
            }

            window.location.href = `/api/usgm/client/report?startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`;
            bootstrap.Modal.getInstance(document.getElementById('reportFilterModal')).hide();
        }
    </script>
</body>

</html>

<style>
    body{
        height: 100%;
        margin: 0;
        padding: 0;
    }
</style>