<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Usage Dashboard</title>
    <link rel="stylesheet" href="css/core.css">
    <link rel="stylesheet" href="css/theme.css">
</head>

<body class="bg-light">

    <div class="container py-4">
        <!-- Usage Stats -->
        <div id="statsContainer">
            <div class="row">
                <!--Usage -->
                <div class="mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Usage</h5>
                            <div class="progress mb-3">
                                <div id="usageProgress" class="progress-bar" role="progressbar"></div>
                            </div>
                            <p id="usageText" class="mb-0"></p>
                        </div>
                    </div>
                </div>
                Current Usage
            </div>

            <!-- Recent Requests -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Recent Requests</h5>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody id="requestsTable">
                                    </tbody>
                                </table>
                                <nav>
                                    <ul class="pagination justify-content-center" id="pagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.js"></script>
    <script>

        function updatePagination(totalCount, currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(totalCount / 20);

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
            pagination.appendChild(nextLi);

            // Add click handlers
            pagination.addEventListener('click', (e) => {
                e.preventDefault();
                const pageLink = e.target.closest('a');
                if (pageLink && !pageLink.parentElement.classList.contains('disabled')) {
                    const page = parseInt(pageLink.dataset.page);
                    loadStats(page);
                }
            });
        }

        let currentPage = 1;

        async function loadStats(page = 1) {
            try {
                console.log(page);
                const usageResponse = await fetch(`/api/usgm/client/usage`);
                const usage = await usageResponse.json();

                const logsResponse = await fetch(`/api/usgm/logs?page=${page}`);
                const logsData = await logsResponse.json();

                updateUsageStats(usage);
                updateRecentRequests(logsData.logs);
                updatePagination(logsData.totalCount, page);
                document.getElementById('statsContainer').style.display = 'block';

            } catch (error) {
                console.error('Error loading stats:', error);
                alert('Failed to load stats. Please check your API key.');
            }
        }

        function updateUsageStats(usage) {
            const percentage = (usage.count / usage.limit) * 100;
            const progress = document.getElementById('usageProgress');
            const usageText = document.getElementById('usageText');

            progress.style.width = `${Math.min(percentage, 100)}%`;
            progress.classList.toggle('bg-danger', percentage > 90);
            usageText.textContent = `${usage.count} requests this month`;
        }

        function updateRecentRequests(logs) {
            const tbody = document.getElementById('requestsTable');
            tbody.innerHTML = '';

            logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(log.requestTime).toLocaleString()}</td>
                    <td>
                        <span class="badge ${log.statusCode < 400 ? 'bg-success' : 'bg-danger'}">
                            ${log.statusCode}
                        </span>
                    </td>
                    <td>${log.duration}</td>
                `;
                tbody.appendChild(row);
            });
        }

        window.addEventListener('DOMContentLoaded', ()=>loadStats(1));

        setInterval(loadStats, 6000);

    </script>
</body>

</html>